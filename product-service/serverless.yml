service: product-service

frameworkVersion: '3'

plugins:
  - serverless-webpack
  - serverless-offline
  - serverless-dotenv-plugin

provider:
  name: aws
  runtime: nodejs14.x
  region: eu-west-1
  httpApi:
    cors: true
  environment:
    SQS_URL: 
      Ref: CreateProductsSQSQue
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - ec2:CreateNetworkInterface
            - ec2:DescribeNetworkInterfaces
            - ec2:DeleteNetworkInterface√ü
          Resource: '*'
        - Effect: Allow
          Action:
            - sqs:*
          Resource:
            Fn::GetAtt: [CreateProductsSQSQue, Arn ]

custom:
  webpack: # serverless-webpack plugin options
    webpackConfig: webpack.config.js # Name of webpack configuration file
    includeModules:
      forceInclude:
        - pg

package:
  individually: true

resources: 
  Resources:
    CreateProductsSQSQue:
      Type: "AWS::SQS::Queue"
      Properties:
        QueueName: create-batch-of-toys-queue
  Outputs:
    sqsUrl:
      Value: ${self:provider.environment.SQS_URL}
      Export:
        Name: sqsUrl
    sqsArn:
      Value: !GetAtt CreateProductsSQSQue.Arn
      Export:
        Name: sqsArn

functions:
  getProductsList:
    handler: src/handler.getProductsList
    events:
      - httpApi:
          method: GET
          path: /products
  getProductsById:
    handler:  src/handler.getProductsById
    events:
      - httpApi:
          method: GET
          path: /products/{id}
  createProduct:
    handler:  src/handler.createProduct
    events:
      - httpApi:
          method: POST
          path: /products
  catalogBatchProcess: 
    handler: src/handler.catalogBatchProcess
    events: 
      - sqs:
          batchSize: 5
          arn:
            Fn::GetAtt:
              - CreateProductsSQSQue
              - Arn


